/** vim: et:ts=4:sw=4:sts=4
 * @license RequireJS 2.1.11 Copyright (c) 2010-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/requirejs for details
 */

var requirejs,require,define;(function(global){function isFunction(e){return ostring.call(e)==="[object Function]"}function isArray(e){return ostring.call(e)==="[object Array]"}function each(e,t){if(e){var n;for(n=0;n<e.length;n+=1)if(e[n]&&t(e[n],n,e))break}}function eachReverse(e,t){if(e){var n;for(n=e.length-1;n>-1;n-=1)if(e[n]&&t(e[n],n,e))break}}function hasProp(e,t){return hasOwn.call(e,t)}function getOwn(e,t){return hasProp(e,t)&&e[t]}function eachProp(e,t){var n;for(n in e)if(hasProp(e,n)&&t(e[n],n))break}function mixin(e,t,n,r){return t&&eachProp(t,function(t,i){if(n||!hasProp(e,i))r&&typeof t=="object"&&t&&!isArray(t)&&!isFunction(t)&&!(t instanceof RegExp)?(e[i]||(e[i]={}),mixin(e[i],t,n,r)):e[i]=t}),e}function bind(e,t){return function(){return t.apply(e,arguments)}}function scripts(){return document.getElementsByTagName("script")}function defaultOnError(e){throw e}function getGlobal(e){if(!e)return e;var t=global;return each(e.split("."),function(e){t=t[e]}),t}function makeError(e,t,n,r){var i=new Error(t+"\nhttp://requirejs.org/docs/errors.html#"+e);return i.requireType=e,i.requireModules=r,n&&(i.originalError=n),i}function newContext(e){function m(e){var t,n,r=e.length;for(t=0;t<r;t++){n=e[t];if(n===".")e.splice(t,1),t-=1;else if(n===".."){if(t===1&&(e[2]===".."||e[0]===".."))break;t>0&&(e.splice(t-1,2),t-=2)}}}function g(e,t,n){var r,i,s,u,a,f,l,c,h,p,d,v=t&&t.split("/"),g=v,y=o.map,b=y&&y["*"];e&&e.charAt(0)==="."&&(t?(g=v.slice(0,v.length-1),e=e.split("/"),l=e.length-1,o.nodeIdCompat&&jsSuffixRegExp.test(e[l])&&(e[l]=e[l].replace(jsSuffixRegExp,"")),e=g.concat(e),m(e),e=e.join("/")):e.indexOf("./")===0&&(e=e.substring(2)));if(n&&y&&(v||b)){s=e.split("/");e:for(u=s.length;u>0;u-=1){f=s.slice(0,u).join("/");if(v)for(a=v.length;a>0;a-=1){i=getOwn(y,v.slice(0,a).join("/"));if(i){i=getOwn(i,f);if(i){c=i,h=u;break e}}}!p&&b&&getOwn(b,f)&&(p=getOwn(b,f),d=u)}!c&&p&&(c=p,h=d),c&&(s.splice(0,h,c),e=s.join("/"))}return r=getOwn(o.pkgs,e),r?r:e}function y(e){isBrowser&&each(scripts(),function(t){if(t.getAttribute("data-requiremodule")===e&&t.getAttribute("data-requirecontext")===r.contextName)return t.parentNode.removeChild(t),!0})}function b(e){var t=getOwn(o.paths,e);if(t&&isArray(t)&&t.length>1)return t.shift(),r.require.undef(e),r.require([e]),!0}function w(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function E(e,t,n,i){var s,o,u,a,f=null,l=t?t.name:null,h=e,p=!0,m="";return e||(p=!1,e="_@r"+(d+=1)),a=w(e),f=a[0],e=a[1],f&&(f=g(f,l,i),o=getOwn(c,f)),e&&(f?o&&o.normalize?m=o.normalize(e,function(e){return g(e,l,i)}):m=g(e,l,i):(m=g(e,l,i),a=w(m),f=a[0],m=a[1],n=!0,s=r.nameToUrl(m))),u=f&&!o&&!n?"_unnormalized"+(v+=1):"",{prefix:f,name:m,parentMap:t,unnormalized:!!u,url:s,originalName:h,isDefine:p,id:(f?f+"!"+m:m)+u}}function S(e){var t=e.id,n=getOwn(u,t);return n||(n=u[t]=new r.Module(e)),n}function x(e,t,n){var r=e.id,i=getOwn(u,r);hasProp(c,r)&&(!i||i.defineEmitComplete)?t==="defined"&&n(c[r]):(i=S(e),i.error&&t==="error"?n(i.error):i.on(t,n))}function T(e,t){var n=e.requireModules,r=!1;t?t(e):(each(n,function(t){var n=getOwn(u,t);n&&(n.error=e,n.events.error&&(r=!0,n.emit("error",e)))}),r||req.onError(e))}function N(){globalDefQueue.length&&(apsp.apply(l,[l.length,0].concat(globalDefQueue)),globalDefQueue=[])}function C(e){delete u[e],delete a[e]}function k(e,t,n){var r=e.map.id;e.error?e.emit("error",e.error):(t[r]=!0,each(e.depMaps,function(r,i){var s=r.id,o=getOwn(u,s);o&&!e.depMatched[i]&&!n[s]&&(getOwn(t,s)?(e.defineDep(i,c[s]),e.check()):k(o,t,n))}),n[r]=!0)}function L(){var e,n,i=o.waitSeconds*1e3,u=i&&r.startTime+i<(new Date).getTime(),f=[],l=[],c=!1,h=!0;if(t)return;t=!0,eachProp(a,function(e){var t=e.map,r=t.id;if(!e.enabled)return;t.isDefine||l.push(e);if(!e.error)if(!e.inited&&u)b(r)?(n=!0,c=!0):(f.push(r),y(r));else if(!e.inited&&e.fetched&&t.isDefine){c=!0;if(!t.prefix)return h=!1}});if(u&&f.length)return e=makeError("timeout","Load timeout for modules: "+f,null,f),e.contextName=r.contextName,T(e);h&&each(l,function(e){k(e,{},{})}),(!u||n)&&c&&(isBrowser||isWebWorker)&&!s&&(s=setTimeout(function(){s=0,L()},50)),t=!1}function A(e){hasProp(c,e[0])||S(E(e[0],null,!0)).init(e[1],e[2])}function O(e,t,n,r){e.detachEvent&&!isOpera?r&&e.detachEvent(r,t):e.removeEventListener(n,t,!1)}function M(e){var t=e.currentTarget||e.srcElement;return O(t,r.onScriptLoad,"load","onreadystatechange"),O(t,r.onScriptError,"error"),{node:t,id:t&&t.getAttribute("data-requiremodule")}}function _(){var e;N();while(l.length){e=l.shift();if(e[0]===null)return T(makeError("mismatch","Mismatched anonymous define() module: "+e[e.length-1]));A(e)}}var t,n,r,i,s,o={waitSeconds:7,baseUrl:"./",paths:{},bundles:{},pkgs:{},shim:{},config:{}},u={},a={},f={},l=[],c={},h={},p={},d=1,v=1;return i={require:function(e){return e.require?e.require:e.require=r.makeRequire(e.map)},exports:function(e){e.usingExports=!0;if(e.map.isDefine)return e.exports?c[e.map.id]=e.exports:e.exports=c[e.map.id]={}},module:function(e){return e.module?e.module:e.module={id:e.map.id,uri:e.map.url,config:function(){return getOwn(o.config,e.map.id)||{}},exports:e.exports||(e.exports={})}}},n=function(e){this.events=getOwn(f,e.id)||{},this.map=e,this.shim=getOwn(o.shim,e.id),this.depExports=[],this.depMaps=[],this.depMatched=[],this.pluginMaps={},this.depCount=0},n.prototype={init:function(e,t,n,r){r=r||{};if(this.inited)return;this.factory=t,n?this.on("error",n):this.events.error&&(n=bind(this,function(e){this.emit("error",e)})),this.depMaps=e&&e.slice(0),this.errback=n,this.inited=!0,this.ignore=r.ignore,r.enabled||this.enabled?this.enable():this.check()},defineDep:function(e,t){this.depMatched[e]||(this.depMatched[e]=!0,this.depCount-=1,this.depExports[e]=t)},fetch:function(){if(this.fetched)return;this.fetched=!0,r.startTime=(new Date).getTime();var e=this.map;if(!this.shim)return e.prefix?this.callPlugin():this.load();r.makeRequire(this.map,{enableBuildCallback:!0})(this.shim.deps||[],bind(this,function(){return e.prefix?this.callPlugin():this.load()}))},load:function(){var e=this.map.url;h[e]||(h[e]=!0,r.load(this.map.id,e))},check:function(){if(!this.enabled||this.enabling)return;var e,t,n=this.map.id,i=this.depExports,s=this.exports,o=this.factory;if(!this.inited)this.fetch();else if(this.error)this.emit("error",this.error);else if(!this.defining){this.defining=!0;if(this.depCount<1&&!this.defined){if(isFunction(o)){if(this.events.error&&this.map.isDefine||req.onError!==defaultOnError)try{s=r.execCb(n,o,i,s)}catch(u){e=u}else s=r.execCb(n,o,i,s);this.map.isDefine&&s===undefined&&(t=this.module,t?s=t.exports:this.usingExports&&(s=this.exports));if(e)return e.requireMap=this.map,e.requireModules=this.map.isDefine?[this.map.id]:null,e.requireType=this.map.isDefine?"define":"require",T(this.error=e)}else s=o;this.exports=s,this.map.isDefine&&!this.ignore&&(c[n]=s,req.onResourceLoad&&req.onResourceLoad(r,this.map,this.depMaps)),C(n),this.defined=!0}this.defining=!1,this.defined&&!this.defineEmitted&&(this.defineEmitted=!0,this.emit("defined",this.exports),this.defineEmitComplete=!0)}},callPlugin:function(){var e=this.map,t=e.id,n=E(e.prefix);this.depMaps.push(n),x(n,"defined",bind(this,function(n){var i,s,a,f=getOwn(p,this.map.id),l=this.map.name,c=this.map.parentMap?this.map.parentMap.name:null,h=r.makeRequire(e.parentMap,{enableBuildCallback:!0});if(this.map.unnormalized){n.normalize&&(l=n.normalize(l,function(e){return g(e,c,!0)})||""),s=E(e.prefix+"!"+l,this.map.parentMap),x(s,"defined",bind(this,function(e){this.init([],function(){return e},null,{enabled:!0,ignore:!0})})),a=getOwn(u,s.id),a&&(this.depMaps.push(s),this.events.error&&a.on("error",bind(this,function(e){this.emit("error",e)})),a.enable());return}if(f){this.map.url=r.nameToUrl(f),this.load();return}i=bind(this,function(e){this.init([],function(){return e},null,{enabled:!0})}),i.error=bind(this,function(e){this.inited=!0,this.error=e,e.requireModules=[t],eachProp(u,function(e){e.map.id.indexOf(t+"_unnormalized")===0&&C(e.map.id)}),T(e)}),i.fromText=bind(this,function(n,s){var u=e.name,a=E(u),f=useInteractive;s&&(n=s),f&&(useInteractive=!1),S(a),hasProp(o.config,t)&&(o.config[u]=o.config[t]);try{req.exec(n)}catch(l){return T(makeError("fromtexteval","fromText eval for "+t+" failed: "+l,l,[t]))}f&&(useInteractive=!0),this.depMaps.push(a),r.completeLoad(u),h([u],i)}),n.load(e.name,h,i,o)})),r.enable(n,this),this.pluginMaps[n.id]=n},enable:function(){a[this.map.id]=this,this.enabled=!0,this.enabling=!0,each(this.depMaps,bind(this,function(e,t){var n,s,o;if(typeof e=="string"){e=E(e,this.map.isDefine?this.map:this.map.parentMap,!1,!this.skipMap),this.depMaps[t]=e,o=getOwn(i,e.id);if(o){this.depExports[t]=o(this);return}this.depCount+=1,x(e,"defined",bind(this,function(e){this.defineDep(t,e),this.check()})),this.errback&&x(e,"error",bind(this,this.errback))}n=e.id,s=u[n],!hasProp(i,n)&&s&&!s.enabled&&r.enable(e,this)})),eachProp(this.pluginMaps,bind(this,function(e){var t=getOwn(u,e.id);t&&!t.enabled&&r.enable(e,this)})),this.enabling=!1,this.check()},on:function(e,t){var n=this.events[e];n||(n=this.events[e]=[]),n.push(t)},emit:function(e,t){each(this.events[e],function(e){e(t)}),e==="error"&&delete this.events[e]}},r={config:o,contextName:e,registry:u,defined:c,urlFetched:h,defQueue:l,Module:n,makeModuleMap:E,nextTick:req.nextTick,onError:T,configure:function(e){e.baseUrl&&e.baseUrl.charAt(e.baseUrl.length-1)!=="/"&&(e.baseUrl+="/");var t=o.shim,n={paths:!0,bundles:!0,config:!0,map:!0};eachProp(e,function(e,t){n[t]?(o[t]||(o[t]={}),mixin(o[t],e,!0,!0)):o[t]=e}),e.bundles&&eachProp(e.bundles,function(e,t){each(e,function(e){e!==t&&(p[e]=t)})}),e.shim&&(eachProp(e.shim,function(e,n){isArray(e)&&(e={deps:e}),(e.exports||e.init)&&!e.exportsFn&&(e.exportsFn=r.makeShimExports(e)),t[n]=e}),o.shim=t),e.packages&&each(e.packages,function(e){var t,n;e=typeof e=="string"?{name:e}:e,n=e.name,t=e.location,t&&(o.paths[n]=e.location),o.pkgs[n]=e.name+"/"+(e.main||"main").replace(currDirRegExp,"").replace(jsSuffixRegExp,"")}),eachProp(u,function(e,t){!e.inited&&!e.map.unnormalized&&(e.map=E(t))}),(e.deps||e.callback)&&r.require(e.deps||[],e.callback)},makeShimExports:function(e){function t(){var t;return e.init&&(t=e.init.apply(global,arguments)),t||e.exports&&getGlobal(e.exports)}return t},makeRequire:function(t,n){function s(o,a,f){var l,h,p;return n.enableBuildCallback&&a&&isFunction(a)&&(a.__requireJsBuild=!0),typeof o=="string"?isFunction(a)?T(makeError("requireargs","Invalid require call"),f):t&&hasProp(i,o)?i[o](u[t.id]):req.get?req.get(r,o,t,s):(h=E(o,t,!1,!0),l=h.id,hasProp(c,l)?c[l]:T(makeError("notloaded",'Module name "'+l+'" has not been loaded yet for context: '+e+(t?"":". Use require([])")))):(_(),r.nextTick(function(){_(),p=S(E(null,t)),p.skipMap=n.skipMap,p.init(o,a,f,{enabled:!0}),L()}),s)}return n=n||{},mixin(s,{isBrowser:isBrowser,toUrl:function(e){var n,i=e.lastIndexOf("."),s=e.split("/")[0],o=s==="."||s==="..";return i!==-1&&(!o||i>1)&&(n=e.substring(i,e.length),e=e.substring(0,i)),r.nameToUrl(g(e,t&&t.id,!0),n,!0)},defined:function(e){return hasProp(c,E(e,t,!1,!0).id)},specified:function(e){return e=E(e,t,!1,!0).id,hasProp(c,e)||hasProp(u,e)}}),t||(s.undef=function(e){N();var n=E(e,t,!0),r=getOwn(u,e);y(e),delete c[e],delete h[n.url],delete f[e],eachReverse(l,function(t,n){t[0]===e&&l.splice(n,1)}),r&&(r.events.defined&&(f[e]=r.events),C(e))}),s},enable:function(e){var t=getOwn(u,e.id);t&&S(e).enable()},completeLoad:function(e){var t,n,r,i=getOwn(o.shim,e)||{},s=i.exports;N();while(l.length){n=l.shift();if(n[0]===null){n[0]=e;if(t)break;t=!0}else n[0]===e&&(t=!0);A(n)}r=getOwn(u,e);if(!t&&!hasProp(c,e)&&r&&!r.inited){if(o.enforceDefine&&(!s||!getGlobal(s))){if(b(e))return;return T(makeError("nodefine","No define call for "+e,null,[e]))}A([e,i.deps||[],i.exportsFn])}L()},nameToUrl:function(e,t,n){var i,s,u,a,f,l,c,h=getOwn(o.pkgs,e);h&&(e=h),c=getOwn(p,e);if(c)return r.nameToUrl(c,t,n);if(req.jsExtRegExp.test(e))f=e+(t||"");else{i=o.paths,s=e.split("/");for(u=s.length;u>0;u-=1){a=s.slice(0,u).join("/"),l=getOwn(i,a);if(l){isArray(l)&&(l=l[0]),s.splice(0,u,l);break}}f=s.join("/"),f+=t||(/^data\:|\?/.test(f)||n?"":".js"),f=(f.charAt(0)==="/"||f.match(/^[\w\+\.\-]+:/)?"":o.baseUrl)+f}return o.urlArgs?f+((f.indexOf("?")===-1?"?":"&")+o.urlArgs):f},load:function(e,t){req.load(r,e,t)},execCb:function(e,t,n,r){return t.apply(r,n)},onScriptLoad:function(e){if(e.type==="load"||readyRegExp.test((e.currentTarget||e.srcElement).readyState)){interactiveScript=null;var t=M(e);r.completeLoad(t.id)}},onScriptError:function(e){var t=M(e);if(!b(t.id))return T(makeError("scripterror","Script error for: "+t.id,e,[t.id]))}},r.require=r.makeRequire(),r}function getInteractiveScript(){return interactiveScript&&interactiveScript.readyState==="interactive"?interactiveScript:(eachReverse(scripts(),function(e){if(e.readyState==="interactive")return interactiveScript=e}),interactiveScript)}var req,s,head,baseElement,dataMain,src,interactiveScript,currentlyAddingScript,mainScript,subPath,version="2.1.11",commentRegExp=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/mg,cjsRequireRegExp=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,jsSuffixRegExp=/\.js$/,currDirRegExp=/^\.\//,op=Object.prototype,ostring=op.toString,hasOwn=op.hasOwnProperty,ap=Array.prototype,apsp=ap.splice,isBrowser=typeof window!="undefined"&&typeof navigator!="undefined"&&!!window.document,isWebWorker=!isBrowser&&typeof importScripts!="undefined",readyRegExp=isBrowser&&navigator.platform==="PLAYSTATION 3"?/^complete$/:/^(complete|loaded)$/,defContextName="_",isOpera=typeof opera!="undefined"&&opera.toString()==="[object Opera]",contexts={},cfg={},globalDefQueue=[],useInteractive=!1;if(typeof define!="undefined")return;if(typeof requirejs!="undefined"){if(isFunction(requirejs))return;cfg=requirejs,requirejs=undefined}typeof require!="undefined"&&!isFunction(require)&&(cfg=require,require=undefined),req=requirejs=function(e,t,n,r){var i,s,o=defContextName;return!isArray(e)&&typeof e!="string"&&(s=e,isArray(t)?(e=t,t=n,n=r):e=[]),s&&s.context&&(o=s.context),i=getOwn(contexts,o),i||(i=contexts[o]=req.s.newContext(o)),s&&i.configure(s),i.require(e,t,n)},req.config=function(e){return req(e)},req.nextTick=typeof setTimeout!="undefined"?function(e){setTimeout(e,4)}:function(e){e()},require||(require=req),req.version=version,req.jsExtRegExp=/^\/|:|\?|\.js$/,req.isBrowser=isBrowser,s=req.s={contexts:contexts,newContext:newContext},req({}),each(["toUrl","undef","defined","specified"],function(e){req[e]=function(){var t=contexts[defContextName];return t.require[e].apply(t,arguments)}}),isBrowser&&(head=s.head=document.getElementsByTagName("head")[0],baseElement=document.getElementsByTagName("base")[0],baseElement&&(head=s.head=baseElement.parentNode)),req.onError=defaultOnError,req.createNode=function(e,t,n){var r=e.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script");return r.type=e.scriptType||"text/javascript",r.charset="utf-8",r.async=!0,r},req.load=function(e,t,n){var r=e&&e.config||{},i;if(isBrowser)return i=req.createNode(r,t,n),i.setAttribute("data-requirecontext",e.contextName),i.setAttribute("data-requiremodule",t),i.attachEvent&&!(i.attachEvent.toString&&i.attachEvent.toString().indexOf("[native code")<0)&&!isOpera?(useInteractive=!0,i.attachEvent("onreadystatechange",e.onScriptLoad)):(i.addEventListener("load",e.onScriptLoad,!1),i.addEventListener("error",e.onScriptError,!1)),i.src=n,currentlyAddingScript=i,baseElement?head.insertBefore(i,baseElement):head.appendChild(i),currentlyAddingScript=null,i;if(isWebWorker)try{importScripts(n),e.completeLoad(t)}catch(s){e.onError(makeError("importscripts","importScripts failed for "+t+" at "+n,s,[t]))}},isBrowser&&!cfg.skipDataMain&&eachReverse(scripts(),function(e){head||(head=e.parentNode),dataMain=e.getAttribute("data-main");if(dataMain)return mainScript=dataMain,cfg.baseUrl||(src=mainScript.split("/"),mainScript=src.pop(),subPath=src.length?src.join("/")+"/":"./",cfg.baseUrl=subPath),mainScript=mainScript.replace(jsSuffixRegExp,""),req.jsExtRegExp.test(mainScript)&&(mainScript=dataMain),cfg.deps=cfg.deps?cfg.deps.concat(mainScript):[mainScript],!0}),define=function(e,t,n){var r,i;typeof e!="string"&&(n=t,t=e,e=null),isArray(t)||(n=t,t=null),!t&&isFunction(n)&&(t=[],n.length&&(n.toString().replace(commentRegExp,"").replace(cjsRequireRegExp,function(e,n){t.push(n)}),t=(n.length===1?["require"]:["require","exports","module"]).concat(t))),useInteractive&&(r=currentlyAddingScript||getInteractiveScript(),r&&(e||(e=r.getAttribute("data-requiremodule")),i=contexts[r.getAttribute("data-requirecontext")])),(i?i.defQueue:globalDefQueue).push([e,t,n])},define.amd={jQuery:!0},req.exec=function(text){return eval(text)},req(cfg)})(this),define("../../dist/vendor/requirejs/require.js",function(){}),define("Class",[],function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/,n=function(){},r=0,i=function(e,t){return t};return n.extend=function(n){function f(){!e&&this.init&&(this.__objectId=r++,this.init.apply(this,arguments))}var s=this.prototype;e=!0;var o=new this;e=!1,o.__profiler=o.__profiler||i;for(var u in n){if(u==="__profiler")continue;var a=typeof n[u]=="function"&&typeof s[u]=="function"&&t.test(n[u])?function(e,t){return function(){var n=this._super;this._super=s[e];var r=t.apply(this,arguments);return this._super=n,r}}(u,n[u]):n[u];o[u]=o.__profiler(u,a)}return f.prototype=o,f.constructor=f,f.extend=arguments.callee,f},n}),define("draw-tool",["Class"],function(e){return e.extend({enable:function(e,t){this.fabricCanvas=t,this.options=e,this.start=this.start.bind(this),this.move=this.move.bind(this),this.stop=this.stop.bind(this),this.subscriptions={"custom:mousedown":this.start,"custom:mousemove":this.move,"custom:mouseup":this.stop},this.fabricCanvas.on(this.subscriptions)},disable:function(){this.fabricCanvas.off(this.subscriptions)},start:function(){},move:function(){},stop:function(){this.figure&&this.saveState()},getState:function(){if(this.figure)return this.figure},undo:function(e){e&&this.fabricCanvas.remove(e)}})}),define("button-tool",[],function(){return React.createClass({componentDidMount:function(){this.props.paintManager.registerTool(this.props.name,this.props.tool)},select:function(){this.props.paintManager.selectTool(this.props.name)},render:function(){return React.DOM.li({className:"tools__item tools__item-"+this.props.name+" "+this.props.className},React.DOM.button({title:this.props.title||this.props.name,className:"tools__trigger",onClick:this.select},React.DOM.i({className:"icon icon-"+this.props.name})))}})}),define("line",["./draw-tool","./button-tool"],function(e,t){var n=e.extend({start:function(e){this.x0=e.offsetX,this.y0=e.offsetY,this.figure=new fabric.Line(null,{left:e.offsetX,top:e.offsetY,stroke:this.options.color,strokeWidth:this.options.width,selectable:!1}),this.fabricCanvas.add(this.figure),this.fabricCanvas.renderAll()},move:function(e){var t=this.x0,n=this.y0,r=e.offsetX,i=e.offsetY,s=Math.atan((i-n)/(r-t)),o=s/Math.PI*180,u=Math.sqrt(Math.pow(r-t,2)+Math.pow(i-n,2)),a=r>=t?1:-1;this.figure.set({angle:o,width:a*u}),this.figure.setCoords(),this.fabricCanvas.renderAll()},stop:function(){this.figure&&this.figure.width&&this.saveState()}});return React.createClass({render:function(){return t({name:"line",className:this.props.className,paintManager:this.props.paintManager,tool:new n})}})}),define("rest-api",["Class"],function(e){return e.extend({init:function(){this.endpointApi="api/v1",this.endpointUpload="UploadFile.ashx",this.authToken=null,this.host="/targetprocess",this.hostName="localhost/targetprocess",this.onAuth=$.Callbacks(),this.onLogout=$.Callbacks()},setOnDemandAccount:function(e){this.host="https://"+e+".tpondemand.com",this.hostName=e+".tpondemand.com"},setHost:function(e){this.host=e},isLogged:function(){return Boolean(this.authToken)},auth:function(){return this.get("Authentication").then(function(e){this.authToken=e.Token,this.onAuth.fire()}.bind(this))},getCurrentUser:function(){return this.get("context.asmx").then(function(e){var t=e.LoggedUser,n={name:[t.FirstName,t.LastName].join(" ").trim(),avatarSrc:this.host+"/avatar.ashx?UserId="+t.Id+"&size=100"};return n}.bind(this))},logout:function(){this.authToken=null,this.onLogout.fire()},get:function(e,t){return Q($.ajax({type:"get",url:this.host+"/"+this.endpointApi+"/"+e,data:_.extend({format:"json"},t)})).catch(function(e){throw e.status?new Error(e.statusText):new Error("Unknown error")})},post:function(e,t){return Q($.ajax({type:"post",url:this.host+"/"+this.endpointApi+"/"+e,contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify(t)}))},postAttach:function(e,t){var n=t.split(",")[1],r=atob(n),i=[];for(var s=0;s<r.length;s++)i.push(r.charCodeAt(s));var o=new Blob([new Uint8Array(i)],{type:"image/png"}),u=new FormData;u.append("generalId",e),u.append("files[]",o,"chrome-screenshot.png");var a=Q.defer(),f=new XMLHttpRequest;return f.onerror=a.reject,f.onload=function(){if(f.status===200){var e=JSON.parse(f.responseText).items[0],t={name:e[2],url:e[4],thumbnailUrl:e[5]};a.resolve(t)}else a.reject(new Error("Status code was "+f.status))},f.onprogress=function(t){a.notify(t.loaded/t.total)},f.open("POST",this.host+"/"+this.endpointUpload),f.send(u),a.promise},getForms:function(e){return Q($.ajax({type:"post",url:this.host+"/slice/v1/matrix/listModeActionsV2",contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify({base64:!0,definition:{cells:{items:e.map(function(e){return{id:e}})}}})})).then(function(e){return e.items[0].fixed.items[0].data.types})},getForm:function(e){return Q($.ajax({type:"post",url:this.host+"/slice/v1/matrix/listDataTemplate",contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify({base64:!0,dataItemType:e,definition:{cells:{items:[{id:e}]}}})})).then(function(e){return e.items})},submitForm:function(e,t){return Q($.ajax({type:"post",url:this.host+"/slice/v1/matrix/listAddData",contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify({base64:!0,type:e,values:t,definition:{cells:{items:[{id:e}]}}})})).then(function(e){return e[0].dataItem.data},function(e){throw new Error(e.responseJSON.Message)})}})}),define("settings-form",["rest-api"],function(e){var t=window.localStorage;return React.createClass({getDefaultProps:function(){return{autoLogin:!1}},getInitialState:function(){return{accountName:t.getItem("accountName")||"",host:"",isLogged:!1,status:"ready",user:null}},doLogin:function(e){e.preventDefault();var t=$(this.getDOMNode()).find("[name=login]").val();this.state.status==="success"?this.logout():this.login(t)},logout:function(e){var n=Ladda.create(this.getDOMNode().querySelector("[type=submit]"));n.start(),t.setItem("accountName",""),Q.when(this.props.restApi.logout()).then(function(){this.setState({isLogged:!1,status:"ready"})}.bind(this)).done(function(){n.stop()})},login:function(e){t.setItem("accountName",e),this.setState({status:"pending",statusText:""});var n=Ladda.create(this.getDOMNode().querySelector("[type=submit]"));n.start(),chrome.tabs&&this.props.restApi.setOnDemandAccount(e),Q.when(this.props.restApi.auth()).then(this.props.restApi.getCurrentUser.bind(this.props.restApi)).then(function(e){this.isMounted()&&this.setState({isLogged:!0,status:"success",user:e})}.bind(this)).catch(function(e){this.setState({status:"failure",statusText:e.message})}.bind(this)).done(function(){n.stop()})},componentDidMount:function(){this.props.autoLogin&&this.state.accountName&&this.login(this.state.accountName),this.props.restApi.onAuth.add(function(){this.state.isLogged||Q.when(this.props.restApi.getCurrentUser()).then(function(e){this.isMounted()&&this.setState({isLogged:!0,status:"success",user:e})}.bind(this))}.bind(this))},render:function(){var e,t,n;return this.state.status==="success"&&!this.props.hideResult?e=React.DOM.div({className:"media"},React.DOM.span({className:"pull-left"},React.DOM.img({src:this.state.user.avatarSrc,className:"img-circle media-object"})),React.DOM.div({className:"media-body"},React.DOM.h5({className:"media-heading"},this.state.user.name),React.DOM.div({className:"domain-control"},React.DOM.a({href:this.props.restApi.host},this.props.restApi.hostName)))):e=React.DOM.div({className:"domain-control"},React.DOM.input({className:"form-control",name:"login",type:"text",placeholder:"account",required:!0,pattern:"[A-Za-z-0-9]+",title:"your-host1313",defaultValue:this.state.accountName}),React.DOM.span(null,".tpondemand.com")),this.state.isLogged?t=React.DOM.button({className:"btn btn-default btn-lg btn-block ladda-button","data-style":"slide-left",type:"submit"},React.DOM.span({className:"ladda-label"},"Logout")):t=React.DOM.button({className:"btn btn-success btn-lg btn-block ladda-button","data-style":"slide-left",type:"submit"},React.DOM.span({className:"ladda-label"},"Login")),this.state.status==="failure"&&(n=React.DOM.div({className:"alert alert-danger"},this.state.statusText)),React.DOM.form({className:"form-settings",action:"#",onSubmit:this.doLogin},n,React.DOM.div({className:"form-group"},e),t)}})}),define("popover",[],function(){return React.createClass({getInitialState:function(){return{visible:!1,trigger:!1}},toggle:function(e,t){this.setState({visible:!0,trigger:e})},hide:function(){this.setState({visible:!1})},alignTo:function(e){var t=e;if(!e)return;var n=t.getBoundingClientRect(),r=this.getDOMNode().getBoundingClientRect(),i=n.bottom-r.height/2-n.height/2,s="center";i<0&&(i=n.top,s="top"),i+r.height>$(window).height()&&(i=n.top+n.height-r.height,s="bottom"),i===0?i=3:i+r.height===$(window).height()&&(i-=3);var o;switch(s){case"top":o=n.height/2-3;break;case"bottom":o=r.height-n.height/2;break;default:o=r.height/2}this.setState({arrowStyle:{top:o},style:{top:i}})},componentDidMount:function(){$(document).on("click",function(e){var t=this.state.trigger;(e.target!==this.getDOMNode()&&!$(this.getDOMNode()).find(e.target).length||t&&e.target===t&&!$(t).find(e.target).length)&&this.hide()}.bind(this));var e=new MutationObserver(function(e){this.alignTo(this.state.trigger)}.bind(this)),t={attributes:!0,childList:!0,characterData:!0,subtree:!0};e.observe(this.getDOMNode(),t)},render:function(){var e=React.addons.classSet({"popover right":!0,hidden:!this.state.visible});return React.DOM.div({className:e,style:this.state.style},React.DOM.div({className:"arrow",style:this.state.arrowStyle}),React.DOM.div({className:"popover-content"},this.props.children))}})}),define("settings",["./settings-form","./popover"],function(e,t){return React.createClass({getInitialState:function(){return{bubbleVisible:!1}},toggleBubble:function(){this.refs.popover.toggle(this.getDOMNode())},render:function(){var n;return this.state.bubbleVisible&&(n={display:"block"}),React.DOM.li({className:"tools__item tools__item-settings"},React.DOM.button({title:"settings",className:"tools__trigger",onClick:this.toggleBubble},React.DOM.i({className:"icon icon-settings"})),t({ref:"popover"},e({autoLogin:!0,restApi:this.props.restApi})))}})}),define("card-entity",[],function(){return React.createClass({getInitialState:function(){return{entity:null,isLoaded:!1}},componentDidMount:function(){Q.when(this.loadEntity(this.props.entity)).then(function(e){this.setState({entity:e,isLoaded:!0})}.bind(this)).done()},componentWillReceiveProps:function(e){if((e.entity.Id||e.entity.id)===this.state.entity.Id)return;this.setState({isLoaded:!1}),Q.when(this.loadEntity(e.entity)).then(function(e){this.setState({entity:e,isLoaded:!0})}.bind(this)).done()},loadEntity:function(e){return this.props.restApi.get("Generals/"+(e.Id||e.id),{include:"["+TreeFormat.stringify(["Id","Name","Description",{EntityType:"Name"},{Attachments:["Id","Name","Uri","ThumbnailUri"]},{Project:["Id","Name","Abbreviation","Color"]}])+"]"})},render:function(){if(!this.state.isLoaded)return React.DOM.div(null,"Loaded");var e=this.state.entity,t=_.last(e.Attachments.Items),n=t.ThumbnailUri.replace(/localhost/,"localhost:8080").replace(/100/g,"50"),r=this.props.restApi.host+"/entity/"+e.Id,i;return e.Project&&(i=React.DOM.span({className:"card__project",style:{background:e.Project.Color}},e.Project.Abbreviation)),React.DOM.div({className:"media card"},React.DOM.div({className:"pull-left"},React.DOM.img({src:n,className:"img-rounded media-object"})),React.DOM.div({className:"media-body"},React.DOM.div({className:"card__id"},React.DOM.a({href:r,target:"_blank"},"#",e.Id)," ",e.Name),React.DOM.div({className:"card__description"},e.Description),React.DOM.div({className:"card__info"},i)))}})}),define("add-form-generated",["./card-entity"],function(e){var t=React.createClass({displayName:"FieldInput",serialize:function(){return this.props.field.isVisible?{name:this.props.field.name,type:this.props.field.type,value:$(this.refs.input.getDOMNode()).val()}:null},renderTextarea:function(){var e=this.props.field,t=React.addons.classSet({"form-group":!0,hidden:!e.isVisible});return React.DOM.div({className:t},e.isCustomField?React.DOM.label({htmlFor:e.name},e.caption):"",React.DOM.textarea({ref:"input",name:e.name,id:e.name,className:"form-control",type:e.inputType,defaultValue:e.config.defaultValue,disabled:!e.isVisible,placeholder:e.isCustomField?null:e.caption,required:e.required,"aria-required":e.required,rows:"4"}))},render:function(){var e=this.props.field;if(e.inputType==="text"&&e.options.multiline)return this.renderTextarea();var t=React.addons.classSet({"form-group":!0,hidden:!e.isVisible});return React.DOM.div({className:t},e.isCustomField?React.DOM.label({htmlFor:e.name},e.caption):"",React.DOM.input({ref:"input",name:e.name,id:e.name,className:"form-control",type:e.inputType,defaultValue:e.config.defaultValue,disabled:!e.isVisible,placeholder:e.isCustomField?null:e.caption,required:e.required,"aria-required":e.required}))}}),n=React.createClass({displayName:"FieldSelect",serialize:function(){if(!this.props.field.isVisible)return null;var e=$(this.refs.input.getDOMNode()).val();return{name:this.props.field.name,type:this.props.field.type,value:Array.isArray(e)?e.join(","):e}},render:function(){var e=this.props.field,t=e.options.values.map(function(e){return React.DOM.option({key:e.id,value:e.id,"data-process-id":e.processId},e.title)});e.required||t.unshift(React.DOM.option(null));var n=React.addons.classSet({"form-group":!0,hidden:!e.isVisible});return React.DOM.div({className:n,key:e.name},e.isCustomField?React.DOM.label(null,e.caption):"",React.DOM.select({ref:"input",name:e.name,className:"form-control",defaultValue:e.config.defaultValue,multiple:e.multiple,disabled:!e.isVisible,onChange:this.props.onChange,required:e.required,"aria-required":e.required},t))}}),r=React.createClass({displayName:"FieldUrl",serialize:function(){return this.props.field.isVisible?{name:this.props.field.name,type:this.props.field.type,value:{url:$(this.refs.url.getDOMNode()).val(),label:$(this.refs.label.getDOMNode()).val()}}:null},render:function(){var e=this.props.field;return React.DOM.div({className:e.isVisible?null:"hidden"},React.DOM.div({className:"form-group",key:e.name+"_u"},React.DOM.label(null,e.caption),React.DOM.input({ref:"url",name:e.name+"__url",className:"form-control",type:"url",placeholder:"URL",disabled:!e.isVisible,required:e.required,"aria-required":e.required})),React.DOM.div({className:"form-group",key:e.name+"_d"},React.DOM.input({ref:"label",name:e.name+"__label",className:"form-control",type:"text",placeholder:"URL Description",disabled:!e.isVisible,required:e.required,"aria-required":e.required})))}}),i=React.createClass({displayName:"FieldCheckbox",serialize:function(){return this.props.field.isVisible?$(this.refs.input.getDOMNode()).prop("checked")?{name:this.props.field.name,type:this.props.field.type,value:$(this.refs.input.getDOMNode()).val()}:null:null},render:function(){var e=this.props.field,t=React.addons.classSet({checkbox:!0,hidden:!e.isVisible});return React.DOM.div({className:t,key:e.name},React.DOM.label(null,React.DOM.input({ref:"input",name:e.name,type:"checkbox",value:"true",disabled:!e.isVisible}),e.caption))}});return React.createClass({getInitialState:function(){return{fields:[],processId:null,entity:null,validate:!1}},componentDidMount:function(){this.getDOMNode().addEventListener("invalid",function e(){this.setState({validate:!0}),this.getDOMNode().removeEventListener("invalid",e)}.bind(this),!0),this.props.restApi.getForm(this.props.restId).then(function(e){var t=this.getCurrentProcessId(e);e=this.processFields(e),e=this.filterFieldsByProcessId(e,t),this.setState({processId:Number(t),fields:e})}.bind(this)).done()},getCurrentProcessId:function(e){var t=_.findWhere(e,{id:"project"}),n=_.findWhere(t.options.values,{id:t.options.selectedValue}).processId;return Number(n)},processFields:function(e){return e.splice(1,0,{id:"Description",caption:"Description",options:{multiline:!0},required:!1,type:"Text"}),e=e.map(function(e){e.isCustomField=e.type==="CustomField",e.type=e.fieldType||e.type,e.config=e.config||{defaultValue:null};if(e.type==="DropDown"||e.type==="MultipleSelectionList")e.options={values:e.options.value.split(/\r?\n/).map(function(e){return{id:e,title:e}})};return e.type==="DDL"&&(e.config={defaultValue:e.options.selectedValue}),e.type==="MultipleSelectionList"&&(e.multiple=!0,e.config.defaultValue=e.config.defaultValue.split(/\s*,\s*/)),e.isCustomField?e.name="CustomFields__"+e.caption:e.name=e.id,["Text","Number","Date","TemplatedURL"].indexOf(e.type)>=0&&(e.inputType=e.type==="TemplatedURL"?"text":e.type.toLowerCase()),e}),e},onSelectProject:function(e){var t=Number($(e.target).find("option:selected")[0].dataset.processId);t&&this.setState({fields:this.filterFieldsByProcessId(this.state.fields,t),processId:t})},filterFieldsByProcessId:function(e,t){return t&&(e=e.map(function(e){return e.isVisible=!e.processId||e.processId===t,e})),e},onSubmit:function(e){e.preventDefault();var t=this.getValues(),n=Ladda.create(this.getDOMNode().querySelector("[type=submit]"));n.start(),this.props.restApi.submitForm(this.props.restId,t).then(function(e){return Q.all([e,this.props.restApi.postAttach(e.id,this.props.paintManager.canvas.toDataURL()).progress(function(e){n.setProgress(e)})])}.bind(this)).spread(function(e,t){this.getDOMNode().reset(),this.setState({status:"success",entity:e,attach:t,validate:!1})}.bind(this)).catch(function(e){this.setState({statusText:e.message,status:"failure"})}.bind(this)).done(function(){n.stop()})},getValues:function(){var e=_.compact(_.values(this.refs).map(function(e){return e.serialize()}));return e=e.reduce(function(e,t){var n=t.name.split("__"),r;if(n.length===2){r={name:n[1],value:t.value};var i=_.findWhere(e,{id:n[0]});return i||(i={id:n[0],value:[]},e=e.concat(i)),i.value.push(r),e}return r={id:n[0],value:t.value},e.concat(r)},[]),e.map(function(e){return Array.isArray(e.value)&&(e.value=JSON.stringify(e.value)),e})},render:function(){var s=_.groupBy(this.state.fields,function(e){return e.isCustomField?"custom":"main"}),o=_.object(_.map(s,function(e,s){return e=e.map(function(e){switch(e.type){case"Text":case"Date":case"Number":case"TemplatedURL":return t({key:e.name,ref:e.name,field:e});case"DDL":case"DropDown":case"MultipleSelectionList":return n({key:e.name,ref:e.name,field:e,onChange:e.name==="project"?this.onSelectProject:null});case"CheckBox":return i({key:e.name,ref:e.name,field:e});case"URL":return r({key:e.name,ref:e.name,field:e});default:return null}}.bind(this)),[s,_.compact(e)]}.bind(this))),u,a;this.state.status==="success"?(u=React.DOM.div({className:"alert alert-success"},"Entity is added"),a=e({restApi:this.props.restApi,entity:this.state.entity})):this.state.status==="failure"&&(u=React.DOM.div({className:"alert alert-danger"},this.state.statusText));var f;if(o.custom&&o.custom.length){var l=Boolean(_.where(s.custom,{isVisible:!0}).length),c=React.addons.classSet({"fieldset-customfields":!0,hidden:!l});f=React.DOM.fieldset({className:c},o.custom)}return React.DOM.form({action:"#",onSubmit:this.onSubmit,className:this.state.validate?"validate":null},React.DOM.fieldset({className:"fieldset-main"},u,a,o.main),f,React.DOM.fieldset(null,React.DOM.button({className:"btn btn-success btn-lg btn-block ladda-button","data-style":"expand-left",type:"submit"},React.DOM.span({className:"ladda-label"},"Add"))))}})}),define("add-form",["./add-form-generated","./settings-form"],function(e,t){return React.createClass({getInitialState:function(){return{status:"ready",message:"",items:["userstory","bug","request"],forms:[]}},componentDidMount:function(){this.props.restApi.isLogged()&&this.getForms(),this.props.restApi.onAuth.add(function(){this.getForms()}.bind(this)),this.props.restApi.onLogout.add(function(){this.forceUpdate()}.bind(this))},getForms:function(){this.props.restApi.getForms(this.state.items).then(function(e){e[0].active=!0,this.setState({forms:e})}.bind(this)).done()},render:function(){return this.props.restApi.isLogged()?React.DOM.div({className:"add-form"},React.DOM.div({className:"add-form-inner"},React.DOM.div({className:"column-selector"},React.DOM.ul({className:"nav nav-pills nav-stacked"},this.state.forms.map(function(e){return React.DOM.li({key:e.name,className:e.name.toLowerCase()+(e.active?" active":"")},React.DOM.a({href:"#"+e.name,"data-toggle":"tab"},e.title))}))),React.DOM.div({className:"tab-content column-forms"},this.state.forms.map(function(t){return React.DOM.div({key:t.name,className:"tab-pane "+(t.active?"active":""),id:t.name},e({restApi:this.props.restApi,restId:t.name,paintManager:this.props.paintManager}))}.bind(this))))):t({hideResult:!0,restApi:this.props.restApi})}})}),define("add",["./add-form","./popover"],function(e,t){return React.createClass({getInitialState:function(){return{bubbleVisible:!1}},toggleBubble:function(){this.refs.popover.toggle(this.getDOMNode())},render:function(){return React.DOM.li({className:"tools__item tools__item-add"},React.DOM.button({className:"tools__trigger",title:"add",onClick:this.toggleBubble},React.DOM.i({className:"icon icon-add"})),t({ref:"popover"},e({ref:"form",restApi:this.props.restApi,paintManager:this.props.paintManager})))}})}),define("crop",["Class","./button-tool"],function(e,t){var n=e.extend({enable:function(e,t){this.options=e,this.fabricCanvas=t,this.rect={},$(this.layer()).imgAreaSelect({handles:!0,onSelectEnd:function(e,t){this.rect=t}.bind(this)}),$(document).on("keydown.crop",function(e){e.which===27&&this.onEscape(),e.which===13&&this.onEnter()}.bind(this)),$(document).on("dblclick.crop",function(e){e.target.className.match(/^imgareaselect/)&&this.onEnter()}.bind(this))},disable:function(){$(document).off(".crop"),$(this.layer()).off(".crop"),$(this.layer()).imgAreaSelect({remove:!0})},layer:function(){return this.fabricCanvas.upperCanvasEl},onEnter:function(){var e=this.rect;$(this.layer()).imgAreaSelect({hide:!0});var t={left:e.x1,top:e.y1,width:e.width,height:e.height};this.getState=function(){return{left:t.left,top:t.top,width:this.fabricCanvas.width,height:this.fabricCanvas.height}},this.saveState(),this.fabricCanvas.backgroundImage.left=this.fabricCanvas.backgroundImage.left-t.left,this.fabricCanvas.backgroundImage.top=this.fabricCanvas.backgroundImage.top-t.top,this.fabricCanvas.setDimensions({width:t.width,height:t.height}),this.fabricCanvas.forEachObject(function(e){e.left=e.left-t.left,e.top=e.top-t.top,e.setCoords()}),this.fabricCanvas.renderAll()},onEscape:function(){$(this.layer()).imgAreaSelect({hide:!0})},getState:function(){return{left:this.fabricCanvas.backgroundImage.left,top:this.fabricCanvas.backgroundImage.top,height:this.fabricCanvas.backgroundImage.height,width:this.fabricCanvas.backgroundImage.width}},undo:function(e){this.fabricCanvas.backgroundImage.left=this.fabricCanvas.backgroundImage.left+e.left,this.fabricCanvas.backgroundImage.top=this.fabricCanvas.backgroundImage.top+e.top,this.fabricCanvas.setDimensions({width:e.width,height:e.height}),this.fabricCanvas.forEachObject(function(t){t.left=t.left+e.left,t.top=t.top+e.top,t.setCoords()}),this.fabricCanvas.renderAll()}});return React.createClass({render:function(){return t({name:"crop",className:this.props.className,paintManager:this.props.paintManager,tool:new n})}})}),define("pencil",["Class","./button-tool"],function(e,t){var n=e.extend({enable:function(e,t){this.fabricCanvas=t,t.isDrawingMode=!0,this.fabricCanvas.freeDrawingBrush.width=e.width,this.fabricCanvas.freeDrawingBrush.color=e.color,this.listener=this.stop.bind(this),t.on("path:created",this.listener)},disable:function(){this.fabricCanvas.isDrawingMode=!1,this.fabricCanvas.off("path:created",this.listener)},stop:function(e){e.path.selectable=!1,this.getState=function(){return e.path},this.saveState()},undo:function(e){this.fabricCanvas.remove(e)}});return React.createClass({render:function(){return t({name:"pencil",className:this.props.className,paintManager:this.props.paintManager,tool:new n})}})}),define("rect",["./draw-tool","./button-tool"],function(e,t){var n=e.extend({start:function(e){this.x0=e.offsetX,this.y0=e.offsetY,this.figure=new fabric.Rect({left:e.offsetX,top:e.offsetY,stroke:this.options.color,strokeWidth:this.options.width,fill:!1,selectable:!1}),this.fabricCanvas.add(this.figure),this.fabricCanvas.renderAll()},move:function(e){this.figure.set({width:e.offsetX-this.x0,height:e.offsetY-this.y0}),this.figure.setCoords(),this.fabricCanvas.renderAll()},stop:function(){this.figure&&this.figure.width&&this.figure.height&&this.saveState()}});return React.createClass({render:function(){return t({name:"rect",className:this.props.className,paintManager:this.props.paintManager,tool:new n})}})}),define("circle",["./draw-tool","./button-tool"],function(e,t){var n=e.extend({start:function(e){this.x0=e.offsetX,this.y0=e.offsetY,this.figure=new fabric.Circle({id:_.uniqueId("figure"),left:e.offsetX,top:e.offsetY,fill:!1,stroke:this.options.color,strokeWidth:this.options.width,selectable:!1}),this.fabricCanvas.add(this.figure),this.fabricCanvas.renderAll()},move:function(e){this.figure.set({radius:Math.abs(e.offsetX-this.x0)/2}),this.figure.setCoords(),this.fabricCanvas.renderAll()},stop:function(){this.figure.radius?this.saveState():this.fabricCanvas.remove(this.figure)}});return React.createClass({render:function(){return t({name:"circle",className:this.props.className,paintManager:this.props.paintManager,tool:new n})}})}),function(e){var t=e.fabric||(e.fabric={}),n=t.util.object.extend,r={x1:1,x2:1,y1:1,y2:1},i=t.StaticCanvas.supports("setLineDash");if(t.Arrow){t.warn("fabric.Arrow is already defined");return}t.Arrow=t.util.createClass(t.Line,{type:"arrow",_render:function(e){e.beginPath();var t=this.group&&this.group.type==="path-group";t&&!this.transformMatrix&&e.translate(-this.group.width/2+this.left,-this.group.height/2+this.top);if(!this.strokeDashArray||this.strokeDashArray&&i){var n=this.x1<=this.x2?-1:1,r=this.y1<=this.y2?-1:1,s=this.width/2,o=this.height/2,u=this.width===1?0:1,a=this.height===1?0:1,f=u*n*s,l=a*r*o,c=-1*f,h=-1*l;e.moveTo(f,l),e.lineTo(c,h);var p=.05*o,d=.01*o;e.lineTo(c-p,h-d),e.arcTo(c,h,c-p,h+d,5),e.lineTo(c,h),e.save(),e.fillStyle=e.strokeStyle,e.fill(),e.restore()}e.lineWidth=this.strokeWidth;var v=e.strokeStyle;e.strokeStyle=this.stroke||e.fillStyle,this._renderStroke(e),e.strokeStyle=v}})}(typeof exports!="undefined"?exports:this),define("libs/fabric/arrow",function(){}),define("arrow",["./draw-tool","./button-tool","./libs/fabric/arrow"],function(e,t){var n=e.extend({start:function(e){this.x0=e.offsetX,this.y0=e.offsetY,this.figure=new fabric.Arrow(null,{left:e.offsetX,top:e.offsetY,stroke:this.options.color,strokeWidth:this.options.width,selectable:!1}),this.fabricCanvas.add(this.figure),this.fabricCanvas.renderAll()},move:function(e){var t=this.x0,n=this.y0,r=e.offsetX,i=e.offsetY,s=Math.atan((i-n)/(r-t)),o=s/Math.PI*180,u=Math.sqrt(Math.pow(r-t,2)+Math.pow(i-n,2)),a=r>=t,f=!a,l=i>=n,c=!l,h=0;l&&a&&(h=0),l&&f&&(h=-180),c&&f&&(h=180),c&&a&&(h=-360),this.figure.set({angle:o-h,width:u}),this.figure.setCoords(),this.fabricCanvas.renderAll()}});return React.createClass({render:function(){return t({name:"arrow",className:this.props.className,paintManager:this.props.paintManager,tool:new n})}})}),define("text",["./draw-tool","./button-tool"],function(e,t){var n="...",r=e.extend({enable:function(e,t){this.fabricCanvas=t,this.options=e;var n=!1;this.subscriptions={"object:modified":function(e){n=!0,this.saveState(e)}.bind(this),"text:editing:entered":function(e){this.figure=e.target}.bind(this),"text:editing:exited":function(){n=!0,this.blur()}.bind(this),"custom:mousedown":function(e){if(n){n=!1;return}this.start(e)}.bind(this)},this.fabricCanvas.on(this.subscriptions)},disable:function(){this.fabricCanvas.forEachObject(function(e){e.selectable=!1}),this.fabricCanvas.selection=!1,this.fabricCanvas.discardActiveObject(),this.fabricCanvas.off(this.subscriptions)},start:function(e){this.figure=new fabric.IText(n,{fontSize:28,fontFamily:"Lucida Grande, sans-serif",fontWeight:"normal",left:e.offsetX,top:e.offsetY,lineHeight:1.3,fill:this.options.color,strokeWidth:this.options.width,selectionStart:0,selectionEnd:3,selectable:!1,editable:!0,textBackgroundColor:"rgba(0,0,0,0.5)"}),this.fabricCanvas.add(this.figure),this.fabricCanvas.setActiveObject(this.figure),this.figure.enterEditing(),this.figure.initDelayedCursor(),this.figure.setCoords(),this.fabricCanvas.renderAll()},blur:function(){var e=this.figure;!e.text||e.originalState.text===n&&e.text===e.originalState.text?this.fabricCanvas.remove(e):this.saveState()},getState:function(){var e=this.figure;return{object:e,state:e.originalState.text===n?"initial":_.clone(e.originalState)}},undo:function(e){e.state==="initial"?this.fabricCanvas.remove(e.object):(e.object.set(e.state),e.object.setCoords()),this.fabricCanvas.renderAll()}});return React.createClass({render:function(){return t({name:"text",className:this.props.className,paintManager:this.props.paintManager,tool:new r})}})}),define("color",[],function(){var e=window.localStorage;return React.createClass({getInitialState:function(){return{color:e.getItem("color")||"#"+Math.round(Math.random()*255*255*255).toString(16)}},selectColor:function(t){var n=t.currentTarget.value,r=this.props.paintManager.canvas.getActiveObject()||this.props.paintManager.canvas.getActiveGroup();this.props.paintManager.setColor(n),this.setState({color:n}),e.setItem("color",n);if(r){var i=[r];r.type==="group"&&(i=r.getObjects()),i.forEach(function(e){e.type==="i-text"?e.set("fill",n):e.set("stroke",n)}),this.props.paintManager.canvas.renderAll()}},componentDidMount:function(){this.props.paintManager.setColor(this.state.color)},render:function(){return React.DOM.li({className:"tools__item tools__item-color"},React.DOM.input({title:"color",className:"tools__trigger",type:"color",onChange:this.selectColor,defaultValue:this.state.color}))}})}),define("cursor",["Class","./button-tool"],function(e,t){var n="...",r=e.extend({enable:function(e,t){this.fabricCanvas=t,t.selection=!0,t.forEachObject(function(e){e.selectable=!0}),this.subscriptions={"object:selected":function(e){this.figure=e.target}.bind(this),"object:modified":function(){this.saveState()}.bind(this),"text:editing:entered":function(e){this.figure=e.target}.bind(this),"text:editing:exited":function(){this.blur()}.bind(this)},this.fabricCanvas.on(this.subscriptions),$(document).on("keydown.pencil",".editor_area",function(e){if(e.which===8||e.which===46){e.preventDefault();var t=[];this.figure.type==="group"?(this.fabricCanvas.discardActiveGroup(),t=this.figure.getObjects()):(this.fabricCanvas.discardActiveObject(),t=[this.figure]),this.saveState(),this.fabricCanvas.remove(this.figure),t.forEach(function(e){this.fabricCanvas.remove(e)}.bind(this)),this.figure=null,this.fabricCanvas.renderAll()}}.bind(this))},disable:function(){this.fabricCanvas.discardActiveObject(),this.fabricCanvas.selection=!1,this.fabricCanvas.forEachObject(function(e){e.selectable=!1}),this.fabricCanvas.off(this.subscriptions),$(document).off(".pencil")},blur:function(){var e=this.figure;!e.text||e.originalState.text===n&&e.text===e.originalState.text?this.fabricCanvas.remove(e):this.saveState()},getState:function(){var e=this.figure.type==="group",t=e?this.figure.getObjects():[this.figure];return t.map(function(t){var n={object:t,state:_.clone(t.originalState)};return e||(t.originalState=_.clone(t)),n})},undo:function(e){this.fabricCanvas.discardActiveGroup(),this.fabricCanvas.renderAll(),e.forEach(function(e){_.find(this.fabricCanvas.getObjects(),e.object)||this.fabricCanvas.add(e.object),e.state.width||delete e.state.width,e.state.height||delete e.state.height,e.object.set(e.state),e.object.setCoords()}.bind(this)),this.fabricCanvas.renderAll()}});return React.createClass({render:function(){return t({name:"cursor",className:this.props.className,paintManager:this.props.paintManager,tool:new r})}})}),define("undo",["Class"],function(e){return React.createClass({getInitialState:function(){return{enabled:!1}},select:function(){this.props.paintManager.undo()},componentDidMount:function(){this.props.paintManager.onUndo=function(){this.props.paintManager.states.length===0&&this.setState({enabled:!1})}.bind(this),this.props.paintManager.onStateAdded=function(){this.setState({enabled:!0})}.bind(this)},render:function(){var e=this.state.enabled?null:"disabled";return React.DOM.li({className:"tools__item tools__item-undo"},React.DOM.button({title:"undo",className:"tools__trigger",onClick:this.select,disabled:!this.state.enabled},React.DOM.i({className:"icon icon-undo"})))}})}),define("paint-manager",["Class"],function(e){return e.extend({init:function(e){this.states=[],this.tools={},this.options=e,this.selectedTool=null,this.patchFabric()},start:function(e,t){return Q.when(this.initCanvas(e)).then(t?this.setImageAsBackground.bind(this,t):null).then(this.initEvents.bind(this))},initCanvas:function(e){this.canvas=new fabric.Canvas(e,{selection:!1,perPixelTargetFind:!0,targetFindTolerance:5,width:800,height:600})},setImageAsBackground:function(e){return Q.when(this.loadImage(e)).then(function(e){var t=e.getWidth(),n=e.getHeight(),r=window.devicePixelRatio,i=t/r,s=n/r;e.setWidth(i),e.setHeight(s),this.canvas.setDimensions({width:e.getWidth(),height:e.getHeight()}),this.canvas.setBackgroundImage(e,this.canvas.renderAll.bind(this.canvas))}.bind(this))},loadImage:function(e){var t=Q.defer();return fabric.Image.fromURL(e,function(e){t.resolve(e)}),t.promise},initEvents:function(){var e=!1,t=!1,n=window.navigator.appVersion.indexOf("Mac")>=0;$(document).on("keydown",function(e){e.keyCode===90&&e[n?"metaKey":"ctrlKey"]&&this.undo()}.bind(this)),this.canvas.on({"object:selected":function(e){t=!0,this.trigger("custom:selected",e)},"before:selection:cleared":function(e){t=!1,this.trigger("custom:unselected",e)},"selection:cleared":function(e){t=!1,this.trigger("custom:selection-cleared",e)},"mouse:down":function(n){t||(e=!0,this.trigger("custom:mousedown",n.e))},"mouse:move":function(t){if(e){var n=t.e;this.trigger("custom:mousemove",n)}},"mouse:up":function(t){e&&(this.trigger("custom:mouseup",t.e),e=!1)}})},registerTool:function(e,t){this.tools[e]=t},selectTool:function(e){if(this.selectedTool===e)return;this.selectedTool&&this.tools[this.selectedTool].disable(),this.selectedTool=e,this.tools[this.selectedTool]&&(this.tools[this.selectedTool].enable(this.options,this.canvas),this.tools[this.selectedTool].saveState=this.saveState.bind(this),this.onToolSelected&&this.onToolSelected(this.selectedTool))},setColor:function(e){this.options.color=e,this.selectTool(this.selectedTool)},saveState:function(){var e=this.tools[this.selectedTool],t=e.getState?e.getState():null;this.states.push({state:t,tool:this.selectedTool}),this.onStateAdded&&this.onStateAdded()},undo:function(){var e=this.states.pop();e&&this.tools[e.tool].undo&&this.tools[e.tool].undo(e.state),this.onUndo&&this.onUndo()},patchFabric:function(){fabric.util.getScrollLeftTop=function(e,t){var n,r,i=0,s=0,o=fabric.document.documentElement,u=fabric.document.body||{scrollLeft:0,scrollTop:0};r=e;while(e&&e.parentNode&&!n)e=e.parentNode,e!==fabric.document&&fabric.util.getElementStyle(e,"position")==="fixed"&&(n=e),e!==fabric.document&&r!==t&&fabric.util.getElementStyle(e,"position")==="absolute"?(i=0,s=0):e===fabric.document?(i=u.scrollLeft||o.scrollLeft||i,s=u.scrollTop||o.scrollTop||s):(i+=e.scrollLeft||0,s+=e.scrollTop||0);return{left:i,top:s}}}})}),define("editor",["./line","./settings","./add","./crop","./pencil","./rect","./circle","./arrow","./text","./color","./cursor","./undo","./paint-manager","./rest-api"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){var d=window.localStorage;return React.createClass({getInitialState:function(){var e=window.screenshotUrl||d.getItem("imageUrl")||"";return d.setItem("imageUrl",e),{restApi:new p,paintManager:new h({width:2}),selectedTool:d.getItem("tool")||"rect",imageUrl:e}},loadImage:function(e){this.state.paintManager.start("imageView",e).then(function(){this.state.paintManager.selectTool(this.state.selectedTool)}.bind(this))},onDragOver:function(e){var t=e.dataTransfer,n=t.files&&t.files.length?t.files:t.items;if(n&&n.length){var r=n[0];r.type.match(/image\/([a-z]+)/)&&(e.preventDefault(),e.nativeEvent.dataTransfer.dropEffect="move")}},onDrop:function(e){e.preventDefault();var t=new FileReader;t.onload=function(e){d.setItem("imageUrl",e.target.result),this.state.paintManager.setImageAsBackground(e.target.result)}.bind(this),t.readAsDataURL(e.dataTransfer.files[0])},componentDidMount:function(){this.state.paintManager.onToolSelected=function(e){this.setState({selectedTool:e}),d.setItem("tool",e)}.bind(this),this.loadImage(this.state.imageUrl)},render:function(){return React.DOM.div({className:"editor"},React.DOM.div({className:"editor__tools"},React.DOM.nav({className:"tools"},React.DOM.ul({className:"tools__panel"},n({paintManager:this.state.paintManager,restApi:this.state.restApi}),c({paintManager:this.state.paintManager}),l({className:this.state.selectedTool==="cursor"?"selected":"",paintManager:this.state.paintManager}),i({className:this.state.selectedTool==="pencil"?"selected":"",paintManager:this.state.paintManager}),u({className:this.state.selectedTool==="arrow"?"selected":"",paintManager:this.state.paintManager}),e({className:this.state.selectedTool==="line"?"selected":"",paintManager:this.state.paintManager}),s({className:this.state.selectedTool==="rect"?"selected":"",paintManager:this.state.paintManager}),o({className:this.state.selectedTool==="circle"?"selected":"",paintManager:this.state.paintManager}),a({className:this.state.selectedTool==="text"?"selected":"",paintManager:this.state.paintManager}),r({className:this.state.selectedTool==="crop"?"selected":"",paintManager:this.state.paintManager}),f({paintManager:this.state.paintManager})),React.DOM.div({className:"tools__separator"}),React.DOM.ul({className:"tools__panel"},t({paintManager:this.state.paintManager,restApi:this.state.restApi})))),React.DOM.div({className:"editor__area",tabIndex:"0",onDragOver:this.onDragOver,onDrop:this.onDrop},React.DOM.canvas({id:"imageView"})))}})}),require.config({baseUrl:"./scripts/",paths:{Class:"libs/class"}}),require(["editor"],function(e){setTimeout(function(){React.renderComponent(e(),$(".main")[0])},100)}),window.setScreenshotUrl=function(e){window.screenshotUrl=e},define("main",function(){});