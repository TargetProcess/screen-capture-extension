(function(){var e=null,t=[],n=function(e){return e.title==="Targetprocess Screen Capture"&&e.url.match(/^chrome-extension:\/\//)},r=function(){return new Promise(function(e){chrome.tabs.captureVisibleTab(null,e)})},i=function(t){var n=null;chrome.tabs.onUpdated.addListener(function i(r,s){if(n&&r===n.id&&s.status==="loading"){chrome.tabs.onUpdated.removeListener(i);var o=chrome.extension.getViews().filter(function(e){return e.location.href===n.url})[0];o&&(o.screenshotUrl=t,o.screenshotSelection=e),e=null}});var r=chrome.extension.getURL("editor.html?id="+Number(new Date));chrome.tabs.create({url:r},function(e){n=e})},s=function(e){n(e)||Promise.cast(r()).then(function(e){i(e)})},o=function(e){if(t.indexOf(e.id)>=0){chrome.tabs.sendMessage(e.id,{action:"captureSelection:start"});return}t.push(e.id),chrome.tabs.sendMessage(e.id,{action:"captureSelection:start"})};chrome.tabs.onUpdated.addListener(function(e,n){n.status==="loading"&&t.splice(t.indexOf(e),1)}),chrome.runtime.onMessage.addListener(function(t,n){switch(t.action){case"captureVisible:selected":chrome.tabs.query({active:!0},function(e){s(e[0])});break;case"captureSelection:selected":chrome.tabs.query({active:!0},function(e){o(e[0])});break;case"captureSelection:completed":e=t.selection,s(n.tab)}})})();